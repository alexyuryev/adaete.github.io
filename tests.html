<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>HTML5 Space Invaders Tests</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.4.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <canvas id="game-canvas" width="672" height="768">
    Your browser does not support HTML5 canvas.
  </canvas>
  <script src="https://code.jquery.com/qunit/qunit-2.4.0.js"></script>
  <script src="game.js"></script>
  <script>
    QUnit.assert.isUndefined = function (value, message) {
      var result = (value === undefined);
      this.pushResult({
        result:   result,
        actual:   value,
        expected: undefined,
        message:  message
      });
    };
    QUnit.assert.isFalse = function (value, message) {
      this.pushResult({
        result: (value === false),
        actual: value,
        expected: false,
        message: message
      });
    };
    QUnit.assert.isTrue = function (value, message) {
      this.pushResult({
        result: (value === true),
        actual: value,
        expected: true,
        message: message
      });
    };
    // ========================================================================
    QUnit.module("Space Invaders tests", function (hooks) {
      hooks.beforeEach(function () {
        this.game = new SpaceInvaders.Game();
      });

      QUnit.test("Check game state without calling init.", function (a) {
        a.isFalse(this.game.isInitialized(), "Init state must be false.");
        a.isUndefined(this.game.getScene(), "The scene must be undefined.");
      });

      QUnit.test("Check the behavior when canvas is missing.", function (a) {
        // change the identifier of the target canvas temporarily.
        var canvas = document.getElementById("game-canvas");
        canvas.setAttribute("id", "foo-canvas");

        // check that things actually fail.
        a.isFalse(this.game.init(), "Initialization fails.");
        var initState = this.game.isInitialized();
        a.isFalse(initState, "Init-state should remain false.");
        a.isUndefined(this.game.getScene(), "The scene must be undefined.");

        // restore the original identifier back for the canvas.
        canvas.setAttribute("id", "game-canvas");
      });

      QUnit.test("Recognization of missing 2D context.", function (a) {
        // disable the context retrieval functionality temporarily.
        var canvas = document.getElementById("game-canvas");
        var originalGetContext = canvas.getContext;
        canvas.getContext = function (value) { return null; }

        // check that things actually fail.
        a.isFalse(this.game.init(), "Initialization fails.");
        var initState = this.game.isInitialized();
        a.isFalse(initState, "Init-state should remain false.");
        a.isUndefined(this.game.getScene(), "The scene must be undefined.");

        // restore (re-enable) the context retrieval functionality.
        canvas.getContext = originalGetContext;
      });

      QUnit.module("Initialized Space Invaders tests", function (hooks) {
        hooks.beforeEach(function () {
          this.game.init();
        });

        QUnit.test("Check game state after calling init.", function (a) {
          a.isTrue(this.game.isInitialized(), "Init state must be true.");
          a.isTrue((this.game.getScene() instanceof SpaceInvaders.Scene), "Scene must be assigned.");
        });

        QUnit.test("Check that reinitialization attempts fail.", function (a) {
          a.isFalse(this.game.init(), "Re-initialization must return false.");
          a.isTrue(this.game.isInitialized(), "Init state must stay true.");
          a.isTrue((this.game.getScene() instanceof SpaceInvaders.Scene), "Scene must stay assigned.");
        })

        QUnit.test("Check that base entity works as expected.", function (a) {
          var e = new SpaceInvaders.Entity(this.game);

          // check that injected and default values get assigned correctly.
          a.deepEqual(e.game, this.game, "Game instance must be injected.");
          a.isTrue((e.scene instanceof SpaceInvaders.Scene), "Scene must be injected.");
          a.deepEqual(e.getX(), e.DEFAULT_X, "Initial X-coordinate must be set to default.");
          a.deepEqual(e.getY(), e.DEFAULT_Y, "Initial Y-coordinate must be set to default.");

          // check that setters works as expected.
          e.setX(313);
          e.setY(131);
          a.deepEqual(e.getX(), 313, "X-coordinate setter must set x-value.");
          a.deepEqual(e.getY(), 131, "Y-coordinate setter must set y-value.");
        });
      });
    });
    // ========================================================================
  </script>
</body>
</html>
